DKS=$(wildcard *.dk)

# DKOS need not have the same name that the corresponding Dedukti
# files (modulogic.dk becomes zen.dko) but for each file f.dk, dkdep
# f.dk outputs the name of the produced dko file before the ':'
# character.
DKOS=$(shell cut -d ':' -f 1 .depend)

# BASE_LOC = -I ../../../theory/dk
FLAGS = -e --errors-in-snf

DKDEP=dkdep $(BASE_LOC)
DKCHECK=dkcheck $(BASE_LOC) $(FLAGS)
DKMETA=mv "$(basename $(<F)).dk" "$(basename $(<F))_.dk" && dkmeta "$(basename $(<F))_.dk" > "$(basename $(<F)).dk" ; rm "$(basename $(<F))_.dk" &&

all: replacePrim $(DKOS) num

%.dko:
	$(DKCHECK) $< || echo "Pb with" $<

# as generated by Agda2Dk, the translation of Primitive is broken
replacePrim:
	rm Agda__Primitive.dk && cp ../Agda__Primitive.dk Agda__Primitive.dk

num:
	echo "files typechecked: " && find . -name "*.dko" | wc -l && echo "--" && find . -name "*.dk" | wc -l


clean:
	rm -f *.dko .depend

depend: .depend
.depend:
	$(DKDEP) *.dk > ./.depend

-include .depend
